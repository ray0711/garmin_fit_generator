<div class="exercise-selector-container">
  <!-- Filter Section -->
  <div class="filters-container">
    <mat-accordion multi>
      <mat-expansion-panel expanded="true">
        <mat-expansion-panel-header>
          <mat-panel-title>General Filters</mat-panel-title>
          <!--<mat-panel-description> This is a summary of the content </mat-panel-description>-->
        </mat-expansion-panel-header>
        <!-- General Filters -->
<!--        <div class="filter-section">-->
<!--          <div class="filter-row">-->
            <mat-form-field class="filter-input">
              <mat-label>Name</mat-label>
              <input
                cdkTrapFocus [cdkTrapFocusAutoCapture]="true"
                matInput
                placeholder="Name"
                [(ngModel)]="filterName"
                (ngModelChange)="applyFilters()"
              />
            </mat-form-field>
            <div *ngFor="let column of getOtherColumns()" class="filter-input">
              @if (isNumericColumn(column)) {
                <label class="filter-label">{{ filters[column]?.label }}: {{ filters[column]?.start }}–{{ filters[column]?.end }}</label>
                <div class="slider-row">
                  <mat-slider
                    [min]="$any(filters[column]?.min) ?? 0"
                    [max]="$any(filters[column]?.max) ?? 100"
                    [step]="1"
                    aria-label="{{ filters[column]?.label }} range"
                  >
                    <input
                      matSliderStartThumb
                      [ngModel]="$any(filters[column]?.start ?? filters[column]?.min)"
                      (ngModelChange)="setNumericRange(column, 'start', $any($event))"
                      aria-label="Minimum {{ filters[column]?.label }}"
                    />
                    <input
                      matSliderEndThumb
                      [ngModel]="$any(filters[column]?.end ?? filters[column]?.max)"
                      (ngModelChange)="setNumericRange(column, 'end', $any($event))"
                      aria-label="Maximum {{ filters[column]?.label }}"
                    />
                  </mat-slider>
                </div>
              } @else {
                <mat-form-field class="filter-input">
                  <mat-label>{{ filters[column]?.label }}</mat-label>
                  <mat-select
                    [(ngModel)]="filters[column].selectedValues"
                    (ngModelChange)="applyFilters()"
                    multiple
                  >
                    <mat-option *ngFor="let value of filters[column]?.values" [value]="value">
                      {{ value }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              }
            </div>
<!--          </div>
        </div>-->
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Muscle Filters</mat-panel-title>
          <!--<mat-panel-description> This is a summary of the content </mat-panel-description>-->
        </mat-expansion-panel-header>
        <!-- Muscle Filters -->

        <div class="filter-section" *ngIf="getMuscleColumns().length > 0">
          <div class="filter-row">
            <div *ngFor="let column of getMuscleColumns()" class="filter-input">
              @if (isNumericColumn(column)) {
                <label class="filter-label">{{ filters[column]?.label }}: {{ filters[column]?.start }}–{{ filters[column]?.end }}</label>
                <div class="slider-row">
                  <mat-slider
                    [min]="$any(filters[column]?.min) ?? 0"
                    [max]="$any(filters[column]?.max) ?? 100"
                    [step]="1"
                    aria-label="{{ filters[column]?.label }} range"
                  >
                    <input
                      matSliderStartThumb
                      [ngModel]="$any(filters[column]?.start ?? filters[column]?.min)"
                      (ngModelChange)="setNumericRange(column, 'start', $any($event))"
                      aria-label="Minimum {{ filters[column]?.label }}"
                    />
                    <input
                      matSliderEndThumb
                      [ngModel]="$any(filters[column]?.end ?? filters[column]?.max)"
                      (ngModelChange)="setNumericRange(column, 'end', $any($event))"
                      aria-label="Maximum {{ filters[column]?.label }}"
                    />
                  </mat-slider>
                </div>
              } @else {
                <mat-form-field class="filter-input">
                  <mat-label>{{ filters[column]?.label }}</mat-label>
                  <mat-select
                    [(ngModel)]="filters[column].selectedValues"
                    (ngModelChange)="applyFilters()"
                    multiple
                  >
                    <mat-option *ngFor="let value of filters[column]?.values" [value]="value">
                      {{ value }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              }
            </div>
          </div>
        </div>
      </mat-expansion-panel>

      <!-- Equipment Filters -->
      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title>Equipment Filters</mat-panel-title>
        </mat-expansion-panel-header>
        <div class="filter-section" *ngIf="getEquipmentColumns().length > 0">
          <div class="filter-row">
            <div *ngFor="let column of getEquipmentColumns()" class="filter-input">
              @if (isNumericColumn(column)) {
                @if (filters[column]?.isBinary) {
                  <label class="filter-label">{{ filters[column]?.label }}</label>
                  <mat-button-toggle-group
                    [value]="$any(filters[column]?.binaryState ?? 'any')"
                    (change)="filters[column].binaryState = $any($event.value); applyFilters()"
                    aria-label="{{ filters[column]?.label }} toggle"
                    name="{{ column }}-toggle"
                  >
                    <mat-button-toggle value="any" aria-label="Any">Any</mat-button-toggle>
                    <mat-button-toggle value="yes" aria-label="Yes">Yes</mat-button-toggle>
                    <mat-button-toggle value="no" aria-label="No">No</mat-button-toggle>
                  </mat-button-toggle-group>
                } @else {
                  <label class="filter-label">{{ filters[column]?.label }}: {{ filters[column]?.start }}–{{ filters[column]?.end }}</label>
                  <div class="slider-row">
                    <mat-slider
                      [min]="$any(filters[column]?.min) ?? 0"
                      [max]="$any(filters[column]?.max) ?? 100"
                      [step]="1"
                      aria-label="{{ filters[column]?.label }} range"
                    >
                      <input
                        matSliderStartThumb
                        [ngModel]="$any(filters[column]?.start ?? filters[column]?.min)"
                        (ngModelChange)="setNumericRange(column, 'start', $any($event))"
                        aria-label="Minimum {{ filters[column]?.label }}"
                      />
                      <input
                        matSliderEndThumb
                        [ngModel]="$any(filters[column]?.end ?? filters[column]?.max)"
                        (ngModelChange)="setNumericRange(column, 'end', $any($event))"
                        aria-label="Maximum {{ filters[column]?.label }}"
                      />
                    </mat-slider>
                  </div>
                }
              } @else {
                <mat-form-field class="filter-input">
                  <mat-label>{{ filters[column]?.label }}</mat-label>
                  <mat-select
                    [(ngModel)]="filters[column].selectedValues"
                    (ngModelChange)="applyFilters()"
                    multiple
                  >
                    <mat-option *ngFor="let value of filters[column]?.values" [value]="value">
                      {{ value }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              }
            </div>
          </div>
        </div>

        <div class="filter-actions">
          <button mat-raised-button color="primary" (click)="clearFilters()">
            Clear All Filters
          </button>
          <span class="results-count">
            Showing {{ filteredExercises.length }} of {{ allExercises.length }} exercises
          </span>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </div>
  <!-- Table Section -->
  <div class="table-container">
    <table
      mat-table
      [dataSource]="pagedExercises"
      matSort
      (matSortChange)="sortData($event)"
      class="exercises-table"
    >
      <!-- Category Column -->
      <ng-container matColumnDef="CATEGORY_GARMIN">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          [attr.data-column]="'CATEGORY_GARMIN'"
          class="resizable-header"
        >
          Category
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'CATEGORY_GARMIN')"></div>
        </th>
        <td mat-cell *matCellDef="let exercise" (click)="add_exercise(exercise)">
          <mat-icon>add_circle</mat-icon> {{ exercise.CATEGORY_GARMIN }}
        </td>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="Name">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          [attr.data-column]="'Name'"
          class="resizable-header"
        >
          Exercise Name
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'Name')"></div>
        </th>
        <td mat-cell *matCellDef="let exercise" (click)="openExercise(exercise)">
          {{ exercise.Name }}
          @if (exercise.URL) {
            <mat-icon>open_in_new</mat-icon>
          }
        </td>
      </ng-container>

      <ng-container matColumnDef="DESCRIPTION">
        <th
          mat-header-cell
          *matHeaderCellDef
          mat-sort-header
          [attr.data-column]="'DESCRIPTION'"
          class="resizable-header"
        >
          Description
          <div class="resize-handle" (mousedown)="onResizeStart($event, 'DESCRIPTION')"></div>
        </th>
        <td mat-cell *matCellDef="let exercise" class="exercise-description">
          {{ exercise.DESCRIPTION }}
        </td>
      </ng-container>

      <!-- Image Column -->
      <ng-container matColumnDef="IMAGE">
        <th mat-header-cell *matHeaderCellDef>Image</th>
        <td mat-cell *matCellDef="let exercise">
          @if (exercise.IMAGE) {
            <img
              [src]="exercise.IMAGE"
              alt="{{ exercise.Name }}"
              class="exercise-image"
              (error)="$any($event.target).style.display = 'none'"
            />
          } @else {
            <span>-</span>
          }
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
    <mat-paginator
      [length]="filteredExercises.length"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChange($event)"
      aria-label="Exercise table pagination"
    />
  </div>
</div>
